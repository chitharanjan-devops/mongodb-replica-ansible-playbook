---
- hosts: primary
  become: true
  tasks:
    - name: Ensure MongoDB is started on primary node
      service:
        name: mongod
        state: started

    - name: Initiate replica set on primary
      shell: mongo --eval 'rs.initiate()'
      register: rs_initiate_output
      ignore_errors: yes

    - name: Show rs.initiate output
      debug:
        var: rs_initiate_output.stdout

    - name: Add secondary 1 to replica set
      shell: mongo --eval 'rs.add("172.31.7.108")'
      register: add_secondary_1
      ignore_errors: yes

    - name: Add secondary 2 to replica set
      shell: mongo --eval 'rs.add("172.31.13.183")'
      register: add_secondary_2
      ignore_errors: yes

    - name: Show result of adding secondary 1
      debug:
        var: add_secondary_1.stdout

    - name: Show result of adding secondary 2
      debug:
        var: add_secondary_2.stdout

    - name: Check replica set status
      shell: mongo --eval 'rs.status()'
      register: rs_status_output

    - name: Show replica set status
      debug:
        var: rs_status_output.stdout

- hosts: secondaries
  become: true
  tasks:
    - name: Enable slaveOk on secondary nodes
      shell: mongo --eval 'rs.slaveOk()'
      register: slave_ok_output
      ignore_errors: yes

    - name: Show output of slaveOk command
      debug:
        var: slave_ok_output.stdout
